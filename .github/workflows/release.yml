name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Zig
        uses: mlugg/setup-zig@8d6198c65fb0feaa111df26e6b467fea8345e46f # v2
        with:
          version: 0.15.2

      - name: Run tests
        run: zig build test

      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@de2c0eb89ae2a093876385947365aca7b0e5f844 # v1
        with:
          name: Release v${{ steps.get_version.outputs.VERSION }}
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          generate_release_notes: true
          body: |
            ## Installation

            Fetch this version using the Zig package manager:

            ```bash
            zig fetch --save https://github.com/${{ github.repository }}/archive/refs/tags/${{ github.ref_name }}.tar.gz
            ```

            This will automatically add the dependency to your `build.zig.zon` with the correct hash.

            Then add to your `build.zig`:

            ```zig
            const tth = b.dependency("tth", .{
                .target = target,
                .optimize = optimize,
            });
            exe.root_module.addImport("tth", tth.module("tth"));
            ```

            ## Changes

            See the full changelog below.
